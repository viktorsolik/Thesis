<!DOCTYPE html>
<html>
  <head>
    <title>rws geo object hierrarchy</title>

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />

    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.0/proj4.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/terraformer/1.0.9/terraformer.min.js"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.1.2/terraformer-wkt-parser.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

    <meta charset="utf-8">

    <style>
        #map { position:absolute; top:0; bottom:0; width:100%; }
        body { margin:0; padding:0; }
        .mapboxgl-popup {
            max-width: 350px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
        img {
            max-width: 250px;
            max-height: 150px;
        }
    </style>
  </head>
  <body>
    <script>
        class SPARQLQueryDispatcher {
            constructor() {
                this.endpoint = "http://localhost:3030/data/sparql";
            }

            query( sparqlQuery ) {
                const fullUrl = this.endpoint + '?query=' + encodeURIComponent( sparqlQuery );
                const headers = { 'Accept': 'application/sparql-results+json' };

                return fetch( fullUrl, { headers } ).then( body => body.json() );
            }
        }

        function addClassNode(URI){

        let dispatcher = new SPARQLQueryDispatcher();
        dispatcher.query( `
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            PREFIX geo: <http://www.opengis.net/ont/geosparql#>
            PREFIX rws: <http://otl.rws.nl/otl#>
            PREFIX owl: <http://www.w3.org/2002/07/owl#>

            SELECT DISTINCT ?label ?superClass
            WHERE {
                <` + URI + `> rdf:type owl:Class.

                OPTIONAL{
                <` + URI + `> rdfs:subClassOf ?superClass.  
                FILTER CONTAINS(STR(?superClass), "http://otl.rws.nl/otl")
                }

                OPTIONAL{
                    <` + URI + `> rdfs:label ?label.
                    FILTER (LANG(?label) = "en-GB")
                }
            }`).then( function(value) {         
            value.results.bindings.forEach(function(element) {

                let node = { 
                    "URI": URI, 
                    "label": "", 
                    "parent" : ""
                }

                if(element.label && element.label.value){
                    node["label"] = element.label.value;
                }   

                if(element.superClass && element.superClass.value){
                    node["parent"] = element.superClass.value;
                    if(!classes.some(e => e.URI === node.URI)){
                        classes.push(node);
                        addClassNode(element.superClass.value);
                    }
                }
                else{
                    if(!classes.some(e => e.URI === node.URI)){
                        classes.push(node);
                    }
                }
            });
        });
        }

        const sparqlQuery = `
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
        PREFIX geo: <http://www.opengis.net/ont/geosparql#>
        PREFIX rws: <http://otl.rws.nl/otl#>

        SELECT DISTINCT ?class ?label ?superClass
        WHERE {
            ?object geo:hasGeometry/geo:asWKT ?shape .         
            ?object a ?class.
            FILTER CONTAINS(STR(?class), "http://otl.rws.nl/otl").
        }`;

        var classes = [];

        const queryDispatcher = new SPARQLQueryDispatcher();
        queryDispatcher.query( sparqlQuery ).then( function(value) {         
            value.results.bindings.forEach(function(element) {
                addClassNode(element.class.value);
                //TODO WAIT FOR RECURSION 
            });
        });

    </script>
  </body>
</html>